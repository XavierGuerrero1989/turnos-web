rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ðŸ”¹ Helpers
    function isSignedIn() { return request.auth != null; }
    function isMedico() { return isSignedIn() && request.auth.token.role == 'medico'; }
    function isOwner(uid) { return isSignedIn() && request.auth.uid == uid; }

    // ðŸ”¹ Usuarios bÃ¡sicos
    match /usuarios/{uid} {
      allow read: if isMedico() || isOwner(uid);
      allow create: if isSignedIn() && isOwner(uid);
      allow update: if isMedico() || isOwner(uid);
    }

    // ðŸ”¹ Perfiles clÃ­nicos
    match /perfiles/{uid} {
      allow read: if isMedico() || isOwner(uid);
      allow create, update: if isMedico() || isOwner(uid);
    }

    // ðŸ”¹ Disponibilidades (solo mÃ©dico administra)
    match /disponibilidades/{id} {
      allow read: if true; // visibles para todos
      allow create, update, delete: if isMedico();
    }

    // ðŸ”¹ Solicitudes de turno
    match /solicitudes/{id} {
      allow create: if isSignedIn(); // paciente crea
      allow read, update:
        if isMedico() ||
           (isSignedIn() && request.resource.data.pacienteId == request.auth.uid) ||
           (isSignedIn() && resource.data.pacienteId == request.auth.uid);
      allow delete: if isMedico();
    }

    // ðŸ”¹ Turnos confirmados (legacy, si lo mantenÃ©s separado)
    match /turnosConfirmados/{id} {
      allow read:
        if isMedico() ||
           (isSignedIn() && resource.data.pacienteId == request.auth.uid);
      allow create, update, delete: if isMedico();
    }

    // ðŸ”¹ Notificaciones (propietario = to)
    match /notificaciones/{id} {
      allow create: if isSignedIn();
      allow read, update, delete:
        if isSignedIn() && resource.data.to == request.auth.uid;
    }

    // ðŸ”¹ Evoluciones clÃ­nicas
    match /evoluciones/{id} {
      allow read: if isMedico() || isOwner(resource.data.pacienteId); 
      allow create: if isMedico(); 
      allow update, delete: if isMedico(); // o, mÃ¡s fino, if isMedico() && request.auth.uid == resource.data.medicoId
    }
  }
}
